import{a as S,b as R,e as B,j as H,p as T}from"./chunk-WYJVIY4U.js";import{a as L,b,d as f}from"./chunk-OWCFWPAL.js";import*as l from"expo-linking";import*as d from"expo-web-browser";import{useCallback as z,useContext as V,useEffect as X}from"react";import{Platform as q}from"react-native";import{PrivyClientError as s}from"@privy-io/js-sdk-core";import*as c from"expo-apple-authentication";import{PrivyClientError as K}from"@privy-io/js-sdk-core";function M(e){return f(this,null,function*(){try{return yield c.signInAsync({state:e.state,requestedScopes:[c.AppleAuthenticationScope.EMAIL,c.AppleAuthenticationScope.FULL_NAME]})}catch(i){throw i instanceof Error&&"code"in i&&i.code==="ERR_REQUEST_CANCELED"?new K({error:"Apple login was cancelled",code:e.isLogin?"login_with_oauth_was_cancelled_by_user":"link_with_oauth_was_cancelled_by_user"}):i}})}var W=(e={})=>{let{oAuthState:i,setOAuthState:r,oAuthCallbacks:D,client:u}=V(T),j=B(),a=e.action?e.action==="login":!j;X(()=>{D.current={onSuccess:e.onSuccess,onError:e.onError}},[e.onSuccess,e.onError]);let v=z(U=>{var A;let n=H(U);return r({status:"error",error:n}),(A=e==null?void 0:e.onError)==null||A.call(e,n),n},[e==null?void 0:e.onError]);return{start:z(function(_e){return f(this,arguments,function*({provider:n,redirectUri:A,isLegacyAppleIosBehaviorEnabled:Q=!1,disableSignup:C,onAppleOAuthUserInfo:I}){var P,x,F;r({status:"loading"});let E=R();try{if(E&&e.action==="login")throw new s({code:"attempted_login_with_oauth_while_already_logged_in",error:"Already logged in, if trying to link an OAuth account use `useLinkWithOAuth`"});if(!E&&e.action==="link")throw new s({code:"attempted_link_oauth_before_logged_in",error:"Must be logged in to link an OAuth account, use `useLoginWithOAuth`"});let h=l.createURL(A||"/"),{url:m}=yield u.auth.oauth.generateURL(n,h),t,_;if(q.OS==="ios"&&n==="apple"&&!Q){let g=(P=new URL(m).searchParams.get("state"))!=null?P:"",o=yield M({state:g,isLogin:a});if(console.log("credentials",o),!o.authorizationCode||!o.state)throw new s({error:"OAuth invalid credentials",code:a?"login_with_oauth_returned_with_invalid_credentials":"link_with_oauth_returned_with_invalid_credentials"});if(a){let k=S(),N=yield u.auth.oauth.loginWithCode(o.authorizationCode,o.state,n,"raw",C?"no-signup":"login-or-sign-up",{embedded:k==null?void 0:k.embedded});t=N.user,_=N.is_new_user}else({user:t}=yield u.auth.oauth.linkWithCode(o.authorizationCode,o.state,n,"raw"));return I&&I({fullName:o.fullName,email:o.email}),(x=e==null?void 0:e.onSuccess)==null||x.call(e,t,_),r({status:"done"}),t!=null?t:void 0}let G=q.OS==="android"?m.replace("x.com","twitter.com"):m,p=yield d.openAuthSessionAsync(G,h,{createTask:!1});if(p.type!=="success")throw[d.WebBrowserResultType.CANCEL,d.WebBrowserResultType.DISMISS].includes(p.type)?new s({error:"OAuth was cancelled",code:a?"login_with_oauth_was_cancelled_by_user":"link_with_oauth_was_cancelled_by_user"}):new s({error:"OAuth session failed",code:a?"failed_to_complete_login_with_oauth":"failed_to_complete_link_with_oauth"});let{queryParams:J}=l.parse(p.url),{privy_oauth_state:O,privy_oauth_code:y}=J;if(!y||!O)throw new s({error:"OAuth invalid credentials",code:a?"login_with_oauth_returned_with_invalid_credentials":"link_with_oauth_returned_with_invalid_credentials"});if(a){let w=S(),g=yield u.auth.oauth.loginWithCode(y,O,n,void 0,C?"no-signup":"login-or-sign-up",{embedded:w==null?void 0:w.embedded});t=g.user,_=g.is_new_user}else({user:t}=yield u.auth.oauth.linkWithCode(y,O,n));return(F=e==null?void 0:e.onSuccess)==null||F.call(e,t,_),yield l.openURL(p.url.split("?")[0]),r({status:"done"}),t!=null?t:void 0}catch(h){throw v(h),h}})},[u,r,v]),state:i}};function le(e){let{state:i,start:r}=W(b(L({},e),{action:"login"}));return{state:i,login:r}}function he(e){let{state:i,start:r}=W(b(L({},e),{action:"link"}));return{state:i,link:r}}function ce(e){return W(e)}export{le as a,he as b,ce as c};
