"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { newObj[key] = obj[key]; } } } newObj.default = obj; return newObj; } }var _chunkWYJVIY4Ujs = require('./chunk-WYJVIY4U.js');var _chunkOWCFWPALjs = require('./chunk-OWCFWPAL.js');var _expolinking = require('expo-linking'); var l = _interopRequireWildcard(_expolinking);var _expowebbrowser = require('expo-web-browser'); var d = _interopRequireWildcard(_expowebbrowser);var _react = require('react');var _reactnative = require('react-native');var _jssdkcore = require('@privy-io/js-sdk-core');var _expoappleauthentication = require('expo-apple-authentication'); var c = _interopRequireWildcard(_expoappleauthentication);function M(e){return _chunkOWCFWPALjs.d.call(void 0, this,null,function*(){try{return yield c.signInAsync({state:e.state,requestedScopes:[c.AppleAuthenticationScope.EMAIL,c.AppleAuthenticationScope.FULL_NAME]})}catch(i){throw i instanceof Error&&"code"in i&&i.code==="ERR_REQUEST_CANCELED"?new (0, _jssdkcore.PrivyClientError)({error:"Apple login was cancelled",code:e.isLogin?"login_with_oauth_was_cancelled_by_user":"link_with_oauth_was_cancelled_by_user"}):i}})}var W=(e={})=>{let{oAuthState:i,setOAuthState:r,oAuthCallbacks:D,client:u}=_react.useContext.call(void 0, _chunkWYJVIY4Ujs.p),j=_chunkWYJVIY4Ujs.e.call(void 0, ),a=e.action?e.action==="login":!j;_react.useEffect.call(void 0, ()=>{D.current={onSuccess:e.onSuccess,onError:e.onError}},[e.onSuccess,e.onError]);let v=_react.useCallback.call(void 0, U=>{var A;let n=_chunkWYJVIY4Ujs.j.call(void 0, U);return r({status:"error",error:n}),(A=e==null?void 0:e.onError)==null||A.call(e,n),n},[e==null?void 0:e.onError]);return{start:_react.useCallback.call(void 0, function(_e){return _chunkOWCFWPALjs.d.call(void 0, this,arguments,function*({provider:n,redirectUri:A,isLegacyAppleIosBehaviorEnabled:Q=!1,disableSignup:C,onAppleOAuthUserInfo:I}){var P,x,F;r({status:"loading"});let E=_chunkWYJVIY4Ujs.b.call(void 0, );try{if(E&&e.action==="login")throw new (0, _jssdkcore.PrivyClientError)({code:"attempted_login_with_oauth_while_already_logged_in",error:"Already logged in, if trying to link an OAuth account use `useLinkWithOAuth`"});if(!E&&e.action==="link")throw new (0, _jssdkcore.PrivyClientError)({code:"attempted_link_oauth_before_logged_in",error:"Must be logged in to link an OAuth account, use `useLoginWithOAuth`"});let h=l.createURL(A||"/"),{url:m}=yield u.auth.oauth.generateURL(n,h),t,_;if(_reactnative.Platform.OS==="ios"&&n==="apple"&&!Q){let g=(P=new URL(m).searchParams.get("state"))!=null?P:"",o=yield M({state:g,isLogin:a});if(console.log("credentials",o),!o.authorizationCode||!o.state)throw new (0, _jssdkcore.PrivyClientError)({error:"OAuth invalid credentials",code:a?"login_with_oauth_returned_with_invalid_credentials":"link_with_oauth_returned_with_invalid_credentials"});if(a){let k=_chunkWYJVIY4Ujs.a.call(void 0, ),N=yield u.auth.oauth.loginWithCode(o.authorizationCode,o.state,n,"raw",C?"no-signup":"login-or-sign-up",{embedded:k==null?void 0:k.embedded});t=N.user,_=N.is_new_user}else({user:t}=yield u.auth.oauth.linkWithCode(o.authorizationCode,o.state,n,"raw"));return I&&I({fullName:o.fullName,email:o.email}),(x=e==null?void 0:e.onSuccess)==null||x.call(e,t,_),r({status:"done"}),t!=null?t:void 0}let G=_reactnative.Platform.OS==="android"?m.replace("x.com","twitter.com"):m,p=yield d.openAuthSessionAsync(G,h,{createTask:!1});if(p.type!=="success")throw[d.WebBrowserResultType.CANCEL,d.WebBrowserResultType.DISMISS].includes(p.type)?new (0, _jssdkcore.PrivyClientError)({error:"OAuth was cancelled",code:a?"login_with_oauth_was_cancelled_by_user":"link_with_oauth_was_cancelled_by_user"}):new (0, _jssdkcore.PrivyClientError)({error:"OAuth session failed",code:a?"failed_to_complete_login_with_oauth":"failed_to_complete_link_with_oauth"});let{queryParams:J}=l.parse(p.url),{privy_oauth_state:O,privy_oauth_code:y}=J;if(!y||!O)throw new (0, _jssdkcore.PrivyClientError)({error:"OAuth invalid credentials",code:a?"login_with_oauth_returned_with_invalid_credentials":"link_with_oauth_returned_with_invalid_credentials"});if(a){let w=_chunkWYJVIY4Ujs.a.call(void 0, ),g=yield u.auth.oauth.loginWithCode(y,O,n,void 0,C?"no-signup":"login-or-sign-up",{embedded:w==null?void 0:w.embedded});t=g.user,_=g.is_new_user}else({user:t}=yield u.auth.oauth.linkWithCode(y,O,n));return(F=e==null?void 0:e.onSuccess)==null||F.call(e,t,_),yield l.openURL(p.url.split("?")[0]),r({status:"done"}),t!=null?t:void 0}catch(h){throw v(h),h}})},[u,r,v]),state:i}};function le(e){let{state:i,start:r}=W(_chunkOWCFWPALjs.b.call(void 0, _chunkOWCFWPALjs.a.call(void 0, {},e),{action:"login"}));return{state:i,login:r}}function he(e){let{state:i,start:r}=W(_chunkOWCFWPALjs.b.call(void 0, _chunkOWCFWPALjs.a.call(void 0, {},e),{action:"link"}));return{state:i,link:r}}function ce(e){return W(e)}exports.a = le; exports.b = he; exports.c = ce;
